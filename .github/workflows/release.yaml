name: Release

on:
  release:
    types:
      - published

env:
  BUILD_ARGS: "--all --push"

jobs:
  release:
    name: Release add-ons
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v4

      - name: üîç Find add-on directories
        id: addons
        uses: home-assistant/actions/helpers/find-addons@master

      - name: Get information
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ matrix.addon }}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push add-ons
        uses: home-assistant/builder@master
        with:
          args: |
            ${{ env.BUILD_ARGS }} \
            --all \
            --target /data \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --image "${{ steps.info.outputs.image }}"

  repository:
    name: Update repository
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Update repository.yaml
        run: |
          yq eval '.updated = now' -i repository.yaml
          
      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          add: repository.yaml
          message: "Update repository metadata for release ${{ github.event.release.tag_name }}"
          push: true